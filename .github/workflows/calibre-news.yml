name: Calibre News Delivery
run-name: 'Calibre News Delivery: ${{ github.ref_name }}'

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  worker:
    runs-on: ubuntu-latest
    environment: calibre-news
    env:
      output: converted_ebooks
      publisher: bookfere.com
      author: Calibre News Delivery
      ext: ${{ secrets.FORMAT || 'epub' }}
      size: ${{ secrets.SIZE || 25 }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          
      - name: Install Calibre
        run: |
          sudo apt-get update
          sudo apt-get install libegl1 libopengl0 libxcb-cursor0
          url=https://download.calibre-ebook.com/linux-installer.sh
          sudo -v && wget -nv -O- $url | sudo sh /dev/stdin
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Checking Recipe
        run: |
          echo "å¼€å§‹æ£€æŸ¥recipeæ–‡ä»¶..."
          declare -A recipe_paths
          add_recipe() {
            local name="$(basename "$recipe_path")"
            local key=$(echo "$name" | md5sum | cut -d ' ' -f 1)
            recipe_paths[$key]="$recipe_path"
          }
          
          if [ -f 'recipe_list.txt' ]; then
            echo "æ‰¾åˆ°recipe_list.txtæ–‡ä»¶"
            while IFS= read -r recipe_path || [ -n "$recipe_path" ]; do
              if [ -z "$recipe_path" ]; then continue; fi
              title="${recipe_path%.recipe}"
              result="$(ebook-convert --list-recipes | grep "$title" || true)"
              if [ -z "$result" ]; then
                echo "è­¦å‘Š: Recipe \"$recipe_path\" ä¸å­˜åœ¨"; continue
              fi
              if [ "${recipe_path##*.}" != 'recipe' ]; then
                recipe_path="$recipe_path".recipe
              fi
              add_recipe
            done < recipe_list.txt
          fi
          
          while IFS= read -r -d '' recipe_path; do
            add_recipe
          done < <(find . -maxdepth 1 -type f -name '*.recipe' -print0)
          
          for key in "${!recipe_paths[@]}"; do
            recipe_path="${recipe_paths[$key]}"
            echo "æ‰¾åˆ°recipe: $recipe_path"
            echo "$recipe_path" >> temp_recipe_list.txt
          done
          
          count=${#recipe_paths[@]}
          echo "Recipeæ€»æ•°: $count"
          if [ $count -eq 0 ]; then
            echo 'æ²¡æœ‰æ‰¾åˆ°éœ€è¦å¤„ç†çš„recipe'
            # åˆ›å»ºç©ºæ–‡ä»¶é¿å…åç»­é”™è¯¯
            touch temp_recipe_list.txt
          fi
            
      - name: Converting Ebook
        run: |
          echo "å¼€å§‹ç”µå­ä¹¦è½¬æ¢..."
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p $output
          
          # æ¸…ç©ºä¹‹å‰çš„è¾“å‡º
          rm -f $output/*.${ext,,} 2>/dev/null || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰recipeéœ€è¦å¤„ç†
          if [ ! -f "temp_recipe_list.txt" ] || [ ! -s "temp_recipe_list.txt" ]; then
            echo "æ²¡æœ‰recipeéœ€è¦è½¬æ¢"
            # åˆ›å»ºç©ºæ–‡ä»¶é¿å…åç»­æ­¥éª¤é”™è¯¯
            touch $output/.placeholder
            exit 0
          fi
          
          # è½¬æ¢å‡½æ•°
          convert_ebook() {
            local recipe_path="$1"
            local ebook_name=$(basename "${recipe_path%.*}")
            local output_file="$output/${ebook_name}.${ext,,}"
            
            echo "è½¬æ¢: $recipe_path -> $output_file"
            
            # æ„å»ºå‚æ•°
            local args=()
            args+=(--authors="$author")
            args+=(--publisher="$publisher")
            
            # æ·»åŠ å°é¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            local cover="covers/${ebook_name}.png"
            if [ -f "$cover" ]; then
              args+=(--cover="$cover")
              echo "ä½¿ç”¨å°é¢: $cover"
            fi
            
            # æ·»åŠ æ ·å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            local style="styles/${ebook_name}.css"
            if [ -f "$style" ]; then
              args+=(--extra-css="$style")
              echo "ä½¿ç”¨æ ·å¼: $style"
            fi
            
            # æ‰§è¡Œè½¬æ¢
            echo "å¼€å§‹è½¬æ¢..."
            if ebook-convert "$recipe_path" "$output_file" "${args[@]}"; then
              echo "âœ“ è½¬æ¢æˆåŠŸ: $ebook_name"
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç¡®å®åˆ›å»º
              if [ -f "$output_file" ]; then
                echo "æ–‡ä»¶å·²åˆ›å»º: $(ls -la "$output_file")"
                return 0
              else
                echo "âœ— æ–‡ä»¶æœªåˆ›å»º: $output_file"
                return 1
              fi
            else
              echo "âœ— è½¬æ¢å¤±è´¥: $ebook_name"
              rm -f "$output_file" 2>/dev/null || true
              return 1
            fi
          }
          
          # å¤„ç†æ¯ä¸ªrecipe
          success_count=0
          failure_count=0
          
          echo "å¼€å§‹å¤„ç†recipeåˆ—è¡¨..."
          while IFS= read -r recipe_path || [ -n "$recipe_path" ]; do
            if [ -z "$recipe_path" ]; then
              echo "è·³è¿‡ç©ºè¡Œ"
              continue
            fi
            
            if [ ! -f "$recipe_path" ]; then
              echo "Recipeæ–‡ä»¶ä¸å­˜åœ¨: $recipe_path"
              ((failure_count++))
              continue
            fi
            
            echo "å¤„ç†recipe: $recipe_path"
            if convert_ebook "$recipe_path"; then
              ((success_count++))
            else
              ((failure_count++))
            fi
          done < "temp_recipe_list.txt"
          
          # ç­‰å¾…æ‰€æœ‰è¿›ç¨‹å®Œæˆ
          wait
          
          # ç»Ÿè®¡å®é™…ç”Ÿæˆçš„æ–‡ä»¶
          actual_count=0
          if [ -d "$output" ]; then
            actual_count=$(find "$output" -maxdepth 1 -name "*.${ext,,}" -type f | wc -l)
          fi
          
          echo "=== è½¬æ¢æ€»ç»“ ==="
          echo "æˆåŠŸ: $success_count"
          echo "å¤±è´¥: $failure_count"
          echo "å®é™…ç”Ÿæˆçš„æ–‡ä»¶æ•°: $actual_count"
          
          # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          if [ $actual_count -gt 0 ]; then
            echo "ç”Ÿæˆçš„ç”µå­ä¹¦:"
            find "$output" -maxdepth 1 -name "*.${ext,,}" -type f -exec ls -la {} \;
          else
            echo "æ²¡æœ‰ç”Ÿæˆä»»ä½•ç”µå­ä¹¦"
          fi
          
          # å…³é”®ä¿®å¤ï¼šç®€åŒ–é€€å‡ºé€»è¾‘
          if [ $actual_count -gt 0 ]; then
            echo "è½¬æ¢å®Œæˆï¼Œæœ‰ $actual_count ä¸ªæ–‡ä»¶ç”Ÿæˆ"
            # æ­£å¸¸é€€å‡º
          else
            echo "æ²¡æœ‰ç”Ÿæˆä»»ä½•ç”µå­ä¹¦æ–‡ä»¶"
            # è¿™ä¹Ÿæ˜¯æ­£å¸¸æƒ…å†µï¼Œä¸æ˜¯é”™è¯¯
          fi

      - name: Storing Ebook to Repository
        if: always()  # æ”¹ä¸ºalwaysï¼Œå³ä½¿ä¸Šä¸€æ­¥å¤±è´¥ä¹Ÿæ‰§è¡Œ
        run: |
          echo "å¼€å§‹å­˜å‚¨ç”µå­ä¹¦åˆ°ä»“åº“..."
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
          if [ -d "$output" ] && [ -n "$(ls -A "$output" 2>/dev/null)" ]; then
            echo "æœ‰æ–‡ä»¶éœ€è¦æäº¤"
            
            # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            # æ·»åŠ ç”Ÿæˆçš„æ–‡ä»¶
            git add $output/
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
            if git diff-index --quiet HEAD --; then
              echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
            else
              git commit -m "ğŸ“š Add generated ebooks - $(date +%Y-%m-%d)"
              git push origin HEAD:${GITHUB_REF_NAME}
              echo "æ›´æ”¹å·²æäº¤"
            fi
          else
            echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          fi
          
      - name: Upload Artifact (Backup)
        if: always()  # æ”¹ä¸ºalwaysï¼Œå³ä½¿ä¸Šä¸€æ­¥å¤±è´¥ä¹Ÿæ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: Calibre-News-Delivery
          path: ${{ env.output }}
          retention-days: ${{ secrets.DAYS || 90 }}
