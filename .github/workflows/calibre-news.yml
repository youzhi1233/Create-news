name: Calibre News Delivery
run-name: 'Calibre News Delivery: ${{ github.ref_name }}'

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  worker:
    runs-on: ubuntu-latest
    environment: calibre-news
    env:
      output: converted_ebooks
      publisher: bookfere.com
      author: Calibre News Delivery
      ext: ${{ secrets.FORMAT || 'epub' }}
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          
      - name: Install Calibre
        run: |
          sudo apt-get update
          sudo apt-get install libegl1 libopengl0 libxcb-cursor0
          url=https://download.calibre-ebook.com/linux-installer.sh
          sudo -v && wget -nv -O- $url | sudo sh /dev/stdin
          
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Find Recipe Files
        run: |
          echo "æŸ¥æ‰¾recipeæ–‡ä»¶..."
          # æŸ¥æ‰¾æ‰€æœ‰recipeæ–‡ä»¶
          find . -name "*.recipe" -type f > recipe_files.txt || echo "æ²¡æœ‰æ‰¾åˆ°recipeæ–‡ä»¶"
          cat recipe_files.txt
          
      - name: Convert Ebooks
        id: convert
        run: |
          echo "å¼€å§‹ç”µå­ä¹¦è½¬æ¢..."
          mkdir -p $output
          
          # æ£€æŸ¥æ˜¯å¦æœ‰recipeæ–‡ä»¶
          if [ ! -s recipe_files.txt ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°recipeæ–‡ä»¶"
            echo "count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          success_count=0
          
          # å¤„ç†æ¯ä¸ªrecipeæ–‡ä»¶
          while IFS= read -r recipe_file; do
            if [ -f "$recipe_file" ]; then
              ebook_name=$(basename "$recipe_file" .recipe)
              output_file="$output/${ebook_name}.${ext,,}"
              
              echo "è½¬æ¢: $recipe_file -> $output_file"
              
              # æ„å»ºè½¬æ¢å‚æ•°
              args=()
              args+=(--authors="$author")
              args+=(--publisher="$publisher")
              
              # æ·»åŠ å°é¢ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              cover="covers/${ebook_name}.png"
              if [ -f "$cover" ]; then
                args+=(--cover="$cover")
              fi
              
              # æ·»åŠ æ ·å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
              style="styles/${ebook_name}.css"
              if [ -f "$style" ]; then
                args+=(--extra-css="$style")
              fi
              
              # æ‰§è¡Œè½¬æ¢
              if ebook-convert "$recipe_file" "$output_file" "${args[@]}"; then
                echo "âœ“ è½¬æ¢æˆåŠŸ: $ebook_name"
                ((success_count++))
              else
                echo "âœ— è½¬æ¢å¤±è´¥: $ebook_name"
                # æ¸…ç†å¤±è´¥çš„æ–‡ä»¶
                rm -f "$output_file" 2>/dev/null || true
              fi
            fi
          done < recipe_files.txt
          
          echo "è½¬æ¢å®Œæˆï¼ŒæˆåŠŸ: $success_count"
          echo "count=$success_count" >> $GITHUB_OUTPUT
          
          # ç¡®ä¿è„šæœ¬ä»¥0é€€å‡º
          true

      - name: Store Ebooks to Repository
        if: steps.convert.outputs.count != '0'
        run: |
          echo "å­˜å‚¨ç”µå­ä¹¦åˆ°ä»“åº“..."
          
          # é…ç½®Git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ·»åŠ å¹¶æäº¤ç”µå­ä¹¦æ–‡ä»¶
          git add $output/
          if git diff-index --quiet HEAD --; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          else
            git commit -m "ğŸ“š Add generated ebooks - $(date +%Y-%m-%d)"
            git push origin HEAD:${GITHUB_REF_NAME}
            echo "æ›´æ”¹å·²æäº¤"
          fi
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Calibre-News-Delivery
          path: ${{ env.output }}
          retention-days: ${{ secrets.DAYS || 90 }}
